<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CozyMind - AI-Core 连接监控</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- 固定头部区域 -->
    <div class="fixed-header">
        <div class="container">
            <header>
                <h1>🧠 CozyMind</h1>
                <p class="subtitle">AI 服务管理与监控面板</p>
            </header>
            
            <!-- 主导航标签 -->
            <nav class="main-nav">
                <button class="nav-btn active" data-section="services" onclick="switchSection('services')">
                    🔗 服务管理
                </button>
                <button class="nav-btn" data-section="messages" onclick="switchSection('messages')">
                    💬 消息预设
                </button>
                <button class="nav-btn" data-section="model-setup" onclick="switchSection('model-setup')">
                    ⚙️ 模型设定
                </button>
                <button class="nav-btn" data-section="chat" onclick="switchSection('chat')">
                    💭 用户对话
                </button>
            </nav>
        </div>
    </div>

        <main>
            <!-- 服务管理部分 (AI-Core + Ollama) -->
            <div id="servicesSection" class="section active">
                <!-- 当前选中的连接 -->
                <div class="selected-connection-card">
                    <div class="selected-header">
                        <h2>当前选中连接</h2>
                        <div class="selected-info" id="selectedInfo">
                            <span class="selected-name">未选择</span>
                        </div>
                    </div>
                </div>

                <!-- AI-Core 服务列表 -->
                <div class="services-card">
                    <div class="services-header">
                        <h2>AI-Core 服务列表</h2>
                    </div>
                    
                    <div class="services-grid" id="servicesGrid">
                        <!-- 动态填充服务卡片 -->
                    </div>
                </div>


                <!-- Ollama 配置列表 -->
                <div class="services-card">
                    <div class="services-header">
                        <h2>Ollama 配置列表</h2>
                    </div>
                    
                    <div class="services-grid" id="ollamaGrid">
                        <!-- 动态填充 Ollama 配置卡片 -->
                    </div>
                </div>

                <!-- Ollama 测试区域 -->
                <div class="ollama-test-card" id="ollamaTestCard" style="display: none;">
                    <h2>Ollama 模型测试</h2>
                    <div class="test-form">
                        <div class="form-group">
                            <label>测试提示词</label>
                            <textarea id="testPrompt" rows="4" placeholder="输入测试提示词...">你好，模型！</textarea>
                        </div>
                        <button class="btn btn-primary" onclick="runOllamaTest()">
                            🚀 运行测试
                        </button>
                    </div>
                    
                    <div class="test-result" id="testResult" style="display: none;">
                        <h3>测试结果</h3>
                        <div id="testResultContent"></div>
                    </div>
                </div>
            </div>

            <!-- 消息预设部分 -->
            <div id="messagesSection" class="section">
                <div class="messages-container">
                    <!-- 左侧消息列表 -->
                    <div class="messages-list-panel">
                        <div class="panel-header">
                            <h2>消息列表</h2>
                            <button class="btn btn-sm btn-success" onclick="showAddMessageModal()">
                                ➕ 新建消息
                            </button>
                        </div>
                        <div class="messages-list" id="messagesList">
                            <!-- 动态填充消息列表 -->
                        </div>
                    </div>

                    <!-- 右侧消息详情 -->
                    <div class="message-detail-panel">
                        <div class="panel-header">
                            <h2>消息详情</h2>
                            <div class="detail-actions" id="messageActions" style="display: none;">
                                <button class="btn btn-sm btn-primary" onclick="saveMessageContent()">
                                    💾 保存
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="validateMessageContent()">
                                    ✓ 校验
                                </button>
                            </div>
                        </div>
                        <div class="message-detail-content" id="messageDetailContent">
                            <div class="empty-state">请从左侧选择一条消息</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 日志区域 (仅在服务管理页面显示) -->
            <div class="log-card" id="logCard">
                <div class="log-header">
                    <h2>操作日志</h2>
                    <button class="btn btn-sm btn-text" onclick="clearLogs()">清空</button>
                </div>
                <div class="log-content" id="logContent">
                    <div class="log-item">等待操作...</div>
                </div>
            </div>

            <!-- 模型设定部分 -->
            <div id="modelSetupSection" class="section">
                <div class="model-setup-card">
                    <div class="card-header">
                        <h2>⚙️ 模型系统参数设定</h2>
                        <p class="description">配置 AI 模型的系统提示词，定义模型的行为和角色</p>
                    </div>

                    <!-- AI-Core 服务选择 -->
                    <div class="form-section">
                        <div class="form-group">
                            <label>选择 AI-Core 服务 *</label>
                            <select id="modelAiCoreSelect" onchange="checkAiCoreAvailability()">
                                <option value="">-- 请选择 AI-Core 服务 --</option>
                            </select>
                            <div id="aiCoreStatus" class="service-status"></div>
                        </div>
                    </div>

                    <!-- 消息输入区 -->
                    <div class="form-section">
                        <div class="form-group">
                            <label>系统参数 (System Prompt) *</label>
                            <div class="input-options">
                                <button class="btn btn-sm btn-secondary" onclick="showMessageSelector()">
                                    📋 从消息预设选择
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="clearSystemPrompt()">
                                    🗑️ 清空
                                </button>
                            </div>
                            <textarea 
                                id="systemPromptInput" 
                                rows="8" 
                                placeholder="输入系统参数，例如：&#10;你是一个专业的中文助手，擅长回答各种问题。你的回答应该：&#10;1. 准确、简洁、易懂&#10;2. 使用友好的语气&#10;3. 适时提供相关建议" 
                                oninput="updateCharCount()"></textarea>
                            <div class="char-count">
                                <span id="promptCharCount">0</span> 字符
                            </div>
                        </div>

                        <div class="form-group">
                            <label>会话 ID (可选)</label>
                            <input 
                                type="text" 
                                id="sessionIdInput" 
                                placeholder="留空则自动生成新的会话 ID">
                            <small class="help-text">使用相同的会话 ID 可以继续之前的对话</small>
                        </div>
                    </div>

                    <!-- 操作按钮 -->
                    <div class="action-buttons">
                        <button class="btn btn-primary btn-large" onclick="sendSystemPrompt()" id="sendButton">
                            🚀 发送系统参数
                        </button>
                        <button class="btn btn-secondary" onclick="resetModelSetupForm()">
                            🔄 重置表单
                        </button>
                    </div>

                    <!-- 结果展示区 -->
                    <div id="modelSetupResult" class="result-section" style="display: none;">
                        <h3>📊 发送结果</h3>
                        <div id="resultContent" class="result-content"></div>
                    </div>
                </div>
            </div>

            <!-- 用户对话部分 -->
            <div id="chatSection" class="section">
                <div class="chat-container">
                    <!-- 左侧对话区 -->
                    <div class="chat-main">
                        <div class="chat-header">
                            <h2>💭 用户对话</h2>
                            <div class="chat-controls">
                                <button class="btn btn-sm btn-secondary" onclick="clearChatHistory()">
                                    🗑️ 清空对话
                                </button>
                            </div>
                        </div>

                        <!-- 对话消息列表 -->
                        <div class="chat-messages" id="chatMessages">
                            <div class="chat-welcome">
                                <p>👋 欢迎使用 CozyMind 对话功能</p>
                                <p>输入消息后，将通过 MQTT 发送到 AI-Core 服务处理</p>
                            </div>
                        </div>

                        <!-- 输入区域 -->
                        <div class="chat-input-area">
                            <div class="input-wrapper">
                                <textarea 
                                    id="chatInput" 
                                    rows="3" 
                                    placeholder="输入您的消息..." 
                                    onkeydown="handleChatKeydown(event)"></textarea>
                                <div class="input-actions">
                                    <div class="input-info">
                                        <span id="chatCharCount">0</span> 字符
                                    </div>
                                    <button class="btn btn-primary" onclick="sendChatMessage()" id="chatSendButton">
                                        🚀 发送
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 右侧设置面板 -->
                    <div class="chat-settings">
                        <div class="settings-card">
                            <h3>⚙️ 对话设置</h3>
                            
                            <div class="form-group">
                                <label>MQTT Broker</label>
                                <input type="text" id="chatBrokerHost" value="127.0.0.1" placeholder="Broker 地址">
                            </div>

                            <div class="form-group">
                                <label>端口</label>
                                <input type="text" id="chatBrokerPort" value="1883" placeholder="端口">
                            </div>

                            <div class="form-group">
                                <label>发送主题</label>
                                <input type="text" id="chatPublishTopic" value="/ai-core/from-user/message" placeholder="发送主题">
                            </div>

                            <div class="form-group">
                                <label>接收主题</label>
                                <input type="text" id="chatSubscribeTopic" value="/gui/to-user/response" placeholder="接收主题">
                            </div>

                            <div class="mqtt-status" id="mqttStatus">
                                <span class="status-disconnected">⚫ 未连接</span>
                            </div>

                            <button class="btn btn-primary btn-block" onclick="connectMqtt()" id="mqttConnectButton">
                                🔌 连接 MQTT
                            </button>

                            <button class="btn btn-secondary btn-block" onclick="disconnectMqtt()" id="mqttDisconnectButton" style="display: none;">
                                ⏸️ 断开连接
                            </button>
                        </div>

                        <div class="settings-card">
                            <h3>📊 统计信息</h3>
                            <div class="stats-item">
                                <span>发送消息:</span>
                                <strong id="statSentCount">0</strong>
                            </div>
                            <div class="stats-item">
                                <span>接收消息:</span>
                                <strong id="statReceivedCount">0</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- 添加/编辑 AI-Core 模态框 -->
        <div id="coreModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="coreModalTitle">添加 AI-Core 服务</h2>
                    <button class="modal-close" onclick="closeCoreModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>服务名称 *</label>
                        <input type="text" id="coreName" placeholder="例如: AI-Core 主服务">
                    </div>
                    <div class="form-group">
                        <label>服务地址 *</label>
                        <input type="text" id="coreUrl" placeholder="例如: http://127.0.0.1:9800">
                    </div>
                    <div class="form-group">
                        <label>服务描述</label>
                        <input type="text" id="coreDescription" placeholder="简短描述">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeCoreModal()">取消</button>
                    <button class="btn btn-primary" onclick="saveCoreConfig()">保存</button>
                </div>
            </div>
        </div>

        <!-- 添加/编辑 Ollama 模态框 -->
        <div id="ollamaModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="ollamaModalTitle">添加 Ollama 配置</h2>
                    <button class="modal-close" onclick="closeOllamaModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>配置名称 *</label>
                        <input type="text" id="ollamaName" placeholder="例如: Ollama 本地">
                    </div>
                    <div class="form-group">
                        <label>服务地址 *</label>
                        <input type="text" id="ollamaUrl" placeholder="例如: http://localhost:11434">
                    </div>
                    <div class="form-group">
                        <label>模型名称 *</label>
                        <input type="text" id="ollamaModel" placeholder="例如: llama2, mistral, qwen">
                    </div>
                    <div class="form-group">
                        <label>配置描述</label>
                        <input type="text" id="ollamaDescription" placeholder="简短描述">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeOllamaModal()">取消</button>
                    <button class="btn btn-primary" onclick="saveOllamaConfig()">保存</button>
                </div>
            </div>
        </div>

        <!-- 消息选择器弹窗 -->
        <div id="messageSelectorModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>选择消息预设</h2>
                    <button class="modal-close" onclick="closeMessageSelector()">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="messageSelectorList" class="message-selector-list">
                        <!-- 动态填充消息列表 -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeMessageSelector()">取消</button>
                </div>
            </div>
        </div>

        <!-- 添加消息预设模态框 -->
        <div id="messageModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="messageModalTitle">新建消息</h2>
                    <button class="modal-close" onclick="closeMessageModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>消息标题 *</label>
                        <input type="text" id="messageTitle" placeholder="例如: 问候语">
                    </div>
                    <div class="form-group">
                        <label>消息内容 *</label>
                        <textarea id="messageContent" rows="6" placeholder="输入消息内容..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>消息类型</label>
                        <select id="messageType">
                            <option value="system">系统消息</option>
                            <option value="user">用户消息</option>
                            <option value="assistant">助手消息</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>标签 (可选)</label>
                        <input type="text" id="messageTags" placeholder="例如: 问候, 通用">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeMessageModal()">取消</button>
                    <button class="btn btn-primary" onclick="saveMessage()">保存</button>
                </div>
            </div>
        </div>

        <footer>
            <p>CozyMind v0.1.0 | 自动检测间隔: 5秒</p>
        </footer>

    <script src="app.js"></script>
</body>
</html>

